<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الطلبات والدفع - فاحص أرقام الهواتف</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <h2><i class="fas fa-phone"></i> فاحص الأرقام</h2>
                </div>
                <div class="nav-menu">
                    <a href="dashboard.html" class="nav-link">لوحة التحكم</a>
                    <a href="orders.html" class="nav-link active">الطلبات</a>
                    <div class="user-info">
                        <span id="userEmail"></span>
                        <button onclick="logout()" class="btn btn-small">تسجيل خروج</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="orders-main">
        <div class="container">
            <h1><i class="fas fa-shopping-cart"></i> الطلبات والدفع</h1>
            
            <!-- Current Plan -->
            <div class="current-plan-section">
                <h2>الباقة الحالية</h2>
                <div class="current-plan-card">
                    <div class="plan-info">
                        <h3 id="currentPlanName">-</h3>
                        <p id="currentPlanCredits">-</p>
                        <p class="plan-status" id="planStatus">نشطة</p>
                    </div>
                    <div class="plan-actions">
                        <button onclick="showUpgradePlans()" class="btn btn-primary">ترقية الباقة</button>
                        <button onclick="showRenewPlan()" class="btn btn-secondary">تجديد الباقة</button>
                    </div>
                </div>
            </div>

            <!-- Available Plans -->
            <div id="upgrade-section" class="upgrade-section" style="display: none;">
                <h2>الباقات المتاحة</h2>
                <div class="pricing-grid">
                    <div class="pricing-card" data-plan="basic">
                        <h3>الباقة الأساسية</h3>
                        <div class="price">$10<span>/شهر</span></div>
                        <ul>
                            <li><i class="fas fa-check"></i> 1000 فحص شهرياً</li>
                            <li><i class="fas fa-check"></i> فحص مشغل الشبكة</li>
                            <li><i class="fas fa-check"></i> معلومات البلد</li>
                            <li><i class="fas fa-times"></i> فلترة الواتساب</li>
                            <li><i class="fas fa-times"></i> رفع الملفات</li>
                        </ul>
                        <button onclick="selectPlan('basic', 10)" class="btn btn-primary">اختيار الباقة</button>
                    </div>
                    
                    <div class="pricing-card featured" data-plan="premium">
                        <div class="featured-badge">الأكثر شعبية</div>
                        <h3>الباقة المتقدمة</h3>
                        <div class="price">$25<span>/شهر</span></div>
                        <ul>
                            <li><i class="fas fa-check"></i> 5000 فحص شهرياً</li>
                            <li><i class="fas fa-check"></i> فحص مشغل الشبكة</li>
                            <li><i class="fas fa-check"></i> فلترة الواتساب</li>
                            <li><i class="fas fa-check"></i> معلومات البلد</li>
                            <li><i class="fas fa-check"></i> رفع الملفات</li>
                        </ul>
                        <button onclick="selectPlan('premium', 25)" class="btn btn-primary">اختيار الباقة</button>
                    </div>
                    
                    <div class="pricing-card" data-plan="professional">
                        <h3>الباقة الاحترافية</h3>
                        <div class="price">$50<span>/شهر</span></div>
                        <ul>
                            <li><i class="fas fa-check"></i> فحص غير محدود</li>
                            <li><i class="fas fa-check"></i> جميع المميزات</li>
                            <li><i class="fas fa-check"></i> دعم أولوية</li>
                            <li><i class="fas fa-check"></i> API متقدم</li>
                            <li><i class="fas fa-check"></i> تقارير مفصلة</li>
                        </ul>
                        <button onclick="selectPlan('professional', 50)" class="btn btn-primary">اختيار الباقة</button>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div id="payment-section" class="payment-section" style="display: none;">
                <h2>إتمام عملية الدفع</h2>
                <div class="payment-container">
                    <div class="payment-summary">
                        <h3>ملخص الطلب</h3>
                        <div class="order-item">
                            <span id="selectedPlanName">الباقة المختارة</span>
                            <span id="selectedPlanPrice">$0</span>
                        </div>
                        <div class="order-total">
                            <span>المجموع</span>
                            <span id="totalPrice">$0</span>
                        </div>
                    </div>
                    
                    <div class="payment-form">
                        <h3>معلومات الدفع</h3>
                        <form id="paymentForm">
                            <div class="payment-methods">
                                <label class="payment-method">
                                    <input type="radio" name="paymentMethod" value="card" checked>
                                    <span class="method-icon"><i class="fas fa-credit-card"></i></span>
                                    بطاقة ائتمان
                                </label>
                                <label class="payment-method">
                                    <input type="radio" name="paymentMethod" value="paypal">
                                    <span class="method-icon"><i class="fab fa-paypal"></i></span>
                                    PayPal
                                </label>
                            </div>
                            
                            <div id="card-details" class="card-details">
                                <div class="form-group">
                                    <label for="cardNumber">رقم البطاقة</label>
                                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="expiryDate">تاريخ الانتهاء</label>
                                        <input type="text" id="expiryDate" placeholder="MM/YY" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="cvv">CVV</label>
                                        <input type="text" id="cvv" placeholder="123" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="cardName">اسم حامل البطاقة</label>
                                    <input type="text" id="cardName" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="agreeTerms" required>
                                    <span class="checkmark"></span>
                                    أوافق على <a href="#" target="_blank">شروط الخدمة</a> و <a href="#" target="_blank">سياسة الخصوصية</a>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-full">
                                <i class="fas fa-lock"></i> إتمام الدفع
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order History -->
            <div class="order-history-section">
                <h2>سجل الطلبات</h2>
                <div class="order-history">
                    <div id="ordersList" class="orders-list">
                        <!-- Orders will be dynamically loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // Check if user is logged in
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'login.html';
        }

        let selectedPlan = null;
        let selectedPrice = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userEmail').textContent = user.email;
            loadCurrentPlan();
            loadOrderHistory();
            
            // Check if redirected from registration with plan
            const urlParams = new URLSearchParams(window.location.search);
            const planFromUrl = urlParams.get('plan');
            if (planFromUrl) {
                showUpgradePlans();
                highlightPlan(planFromUrl);
            }
        });

        function loadCurrentPlan() {
            const planNames = {
                'basic': 'الباقة الأساسية',
                'premium': 'الباقة المتقدمة',
                'professional': 'الباقة الاحترافية'
            };
            
            document.getElementById('currentPlanName').textContent = planNames[user.subscription] || 'لا توجد باقة';
            document.getElementById('currentPlanCredits').textContent = user.credits === -1 ? 'فحص غير محدود' : `${user.credits} فحص متبقي`;
        }

        function showUpgradePlans() {
            document.getElementById('upgrade-section').style.display = 'block';
            document.getElementById('payment-section').style.display = 'none';
        }

        function showRenewPlan() {
            if (user.subscription) {
                const prices = { 'basic': 10, 'premium': 25, 'professional': 50 };
                selectPlan(user.subscription, prices[user.subscription]);
            } else {
                showUpgradePlans();
            }
        }

        function highlightPlan(planType) {
            document.querySelectorAll('.pricing-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.plan === planType) {
                    card.classList.add('selected');
                }
            });
        }

        function selectPlan(planType, price) {
            selectedPlan = planType;
            selectedPrice = price;
            
            const planNames = {
                'basic': 'الباقة الأساسية',
                'premium': 'الباقة المتقدمة',
                'professional': 'الباقة الاحترافية'
            };
            
            document.getElementById('selectedPlanName').textContent = planNames[planType];
            document.getElementById('selectedPlanPrice').textContent = `$${price}`;
            document.getElementById('totalPrice').textContent = `$${price}`;
            
            document.getElementById('upgrade-section').style.display = 'none';
            document.getElementById('payment-section').style.display = 'block';
            
            // Scroll to payment section
            document.getElementById('payment-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Payment form handlers
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const cardDetails = document.getElementById('card-details');
                if (this.value === 'card') {
                    cardDetails.style.display = 'block';
                } else {
                    cardDetails.style.display = 'none';
                }
            });
        });

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
            submitBtn.disabled = true;
            
            try {
                // Simulate payment processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Process payment (replace with actual payment gateway)
                const paymentResult = await processPayment(paymentMethod, selectedPlan, selectedPrice);
                
                if (paymentResult.success) {
                    // Update user subscription
                    updateUserSubscription(selectedPlan);
                    
                    // Add to order history
                    addToOrderHistory(selectedPlan, selectedPrice);
                    
                    alert('تم الدفع بنجاح! تم تحديث باقتك.');
                    
                    // Reload page to show updated plan
                    window.location.reload();
                } else {
                    alert('فشل في عملية الدفع. يرجى المحاولة مرة أخرى.');
                }
                
            } catch (error) {
                alert('حدث خطأ في عملية الدفع');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        async function processPayment(method, plan, price) {
            // Simulate payment processing - replace with actual payment gateway
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({ success: true, transactionId: 'TXN' + Date.now() });
                }, 1000);
            });
        }

        function updateUserSubscription(plan) {
            const credits = {
                'basic': 1000,
                'premium': 5000,
                'professional': -1 // unlimited
            };
            
            user.subscription = plan;
            user.credits = credits[plan];
            
            // Update storage
            if (localStorage.getItem('user')) {
                localStorage.setItem('user', JSON.stringify(user));
            } else {
                sessionStorage.setItem('user', JSON.stringify(user));
            }
        }

        function addToOrderHistory(plan, price) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const newOrder = {
                id: 'ORD' + Date.now(),
                plan: plan,
                price: price,
                date: new Date().toISOString(),
                status: 'completed'
            };
            
            orders.unshift(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        function loadOrderHistory() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const ordersList = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="no-orders">لا توجد طلبات سابقة</p>';
                return;
            }
            
            const planNames = {
                'basic': 'الباقة الأساسية',
                'premium': 'الباقة المتقدمة',
                'professional': 'الباقة الاحترافية'
            };
            
            let html = '';
            orders.forEach(order => {
                const date = new Date(order.date).toLocaleDateString('ar');
                html += `
                    <div class="order-item">
                        <div class="order-info">
                            <h4>${planNames[order.plan]}</h4>
                            <p>رقم الطلب: ${order.id}</p>
                            <p>التاريخ: ${date}</p>
                        </div>
                        <div class="order-details">
                            <span class="order-price">$${order.price}</span>
                            <span class="order-status completed">مكتمل</span>
                        </div>
                    </div>
                `;
            });
            
            ordersList.innerHTML = html;
        }

        function logout() {
            localStorage.removeItem('user');
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value;
        });

        // Format expiry date input
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // Format CVV input
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
        });
    </script>
</body>
</html>